#!/usr/bin/env ruby
$: << File.join(File.dirname(__FILE__), '..', 'lib')
require 'protocol'
require 'protocol/dsl'
require 'protocol/language'
require 'protocol/language/c99'
require 'protocol/language/ruby'

# Usage.
unless ARGV.size == 2
  usage = Protocol::Template.new.parse <<-'USAGE'
Generate native code from protocol.

usage: protocol <language> <protocol>
  language     - Native language to generate.
  protocol     - The protocol definition.

languages:
  - data.sort_by(&:language).each do |l|
    = '%-12s - %s' % [l.language, l.description]
  - end
  USAGE

  puts usage.apply(Protocol::Language.all)
  exit 0
end

unless language = Protocol::Language.find(ARGV[0])
  puts 'ERROR: Unknown language "%s".' % ARGV[0]
  exit -1
end

package = Protocol::Dsl.parse(File.read(ARGV[1]), ARGV[1], 0)
puts language.new.apply(package)

